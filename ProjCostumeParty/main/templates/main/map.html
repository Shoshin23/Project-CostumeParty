{% extends "main/home.html" %}
 {% block content %}
 <div id="map" style="width:100%;height:100%"></div>
 <script>
     // Note: This example requires that you consent to location sharing when
     // prompted by your browser. If you see the error "The Geolocation service
     // failed.", it means you probably did not give permission for the browser to
     // locate you.
    //  var address='San Diego, CA'
     function initMap() {
       var geocoder = new google.maps.Geocoder()
       var map = new google.maps.Map(document.getElementById('map'), {
         center: {lat: -34.397, lng: 150.644},
         zoom: 12
       });
//        function someFunction(addresses, callback) {
//     var coords = [];
//     for(var i = 0; i < addresses.length; i++) {
//         currAddress = addresses[i];
//         var geocoder = new google.maps.Geocoder();
//         if (geocoder) {
//             geocoder.geocode({'address':currAddress}, function (results, status) {
//                 if (status == google.maps.GeocoderStatus.OK) {
//                     coords.push(results[0].geometry.location);
//                     if(coords.length == addresses.length) {
//                         if( typeof callback == 'function' ) {
//                             callback(coords);
//                         }
//                     }
//                 }
//                 else {
//                     throw('No results found: ' + status);
//                 }
//             });
//         }
//      }
//   }
//
//   var addresses = [{% for post in posts %} '{{ post.location}}', {% endfor %}]
//   someFunction(addresses, function(coords) {
//     console.log(coords)
// });

var getLatLng = function(addresses, callback) {
            var coords = [];

            addresses.forEach(function(address) {

                var geocoder = new google.maps.Geocoder();
                geocoder.geocode({'address': address}, function (results, status) {

                    if (status == google.maps.GeocoderStatus.OK) {
                        var lat = results[0].geometry.location.lat();
                        var lng = results[0].geometry.location.lng();
                        coords.push([lat, lng]);

                        // all addresses have been processed
                        if (coords.length === addresses.length)
                            callback(coords);
                    }
                });
            });
        }

var allAddresses = [{% for post in posts %} '{{ post.location}}', {% endfor %}]
        getLatLng(allAddresses, function (results) {
            console.log("received all addresses:", results);
        });


       // Try HTML5 geolocation.
       if (navigator.geolocation) {
         navigator.geolocation.getCurrentPosition(function(position) {
           var pos = {
             lat: position.coords.latitude,
             lng: position.coords.longitude
           };

           map.setCenter(pos);
         }, function() {
           handleLocationError(true, infoWindow, map.getCenter());
         });
       } else {
         // Browser doesn't support Geolocation
         handleLocationError(false, infoWindow, map.getCenter());
       }
     }



     function handleLocationError(browserHasGeolocation, infoWindow, pos) {
       infoWindow.setPosition(pos);
       infoWindow.setContent(browserHasGeolocation ?
                             'Error: The Geolocation service failed.' :
                             'Error: Your browser doesn\'t support geolocation.');
     }
   </script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAfn2_kLr3h4v6t2GLnFtPPMyHBeIIQGwM&callback=initMap"></script>
</div>
{% endblock %}
